<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<script>
function showTab(tabName, clickedButton) {
    const contents = document.querySelectorAll('.tab-content');
    contents.forEach(content => {
        content.classList.remove('active');
    });

    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(button => {
        button.classList.remove('active');
    });

    const targetContent = document.getElementById(tabName + '-content');
    if (targetContent) {
        targetContent.classList.add('active');
    }
    
    if (clickedButton) {
        clickedButton.classList.add('active');
    }
}

Chart.register(ChartDataLabels);

document.addEventListener('DOMContentLoaded', function() {
    // ---------------------------------------------------------
    // プライバシーモード機能
    // ---------------------------------------------------------
    const privacyBtn = document.getElementById('privacy-toggle-btn');
    const eyeIcon = document.getElementById('eye-icon');
    
    // 隠すべき要素のセレクタ (金額 + バッジの%表示)
    const privacySelectors = [
        '.total-amount',       // 総資産
        '.profit-amount',      // 損益額
        '.day-change-amount',  // 前日比額
        '.card-amount-new',    // カードの資産額
        '.detail-amount',      // カードの詳細金額
        '.profit-badge',       // 損益%バッジ
        '.day-change-badge',   // 前日比%バッジ
        '.detail-badge'        // 詳細バッジ
    ];

    // ページロード時に現在の値を保存
    const elementsToHide = document.querySelectorAll(privacySelectors.join(','));
    elementsToHide.forEach(el => {
        if (!el.getAttribute('data-original')) {
            el.setAttribute('data-original', el.innerText.trim());
        }
    });

    // アイコンSVG定義
    const iconEyeOpen = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
    const iconEyeClosed = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';

    function setPrivacyMode(isPrivate) {
        // 状態保存
        localStorage.setItem('privacy_mode', isPrivate);
        
        // アイコンとタイトル切り替え
        if (isPrivate) {
            eyeIcon.innerHTML = iconEyeClosed;
            privacyBtn.setAttribute('title', '金額を表示');
        } else {
            eyeIcon.innerHTML = iconEyeOpen;
            privacyBtn.setAttribute('title', '金額を隠す');
        }

        // 表示切り替え
        elementsToHide.forEach(el => {
            if (isPrivate) {
                el.innerText = '*****';
            } else {
                el.innerText = el.getAttribute('data-original');
            }
        });
    }

    // 初期状態の適用
    const savedMode = localStorage.getItem('privacy_mode') === 'true';
    if (savedMode) {
        setPrivacyMode(true);
    }

    // クリックイベント
    if (privacyBtn) {
        privacyBtn.addEventListener('click', function() {
            const currentMode = localStorage.getItem('privacy_mode') === 'true';
            setPrivacyMode(!currentMode);
        });
    }


    // ---------------------------------------------------------
    // チャート描画処理
    // ---------------------------------------------------------
    const chartDataJSON = '{{ chart_data | safe }}';
    const historyDataJSON = '{{ history_data | safe }}';
    let myLineChart;

    const assetColors = [
        '#E63946', '#457B9D', '#F4A261', '#E9C46A', 
        '#9B5DE5', '#52B788', '#F15BB5'
    ];
    const totalAssetColor = '#808080';

    function hexToRgba(hex, alpha) {
        let r = 0, g = 0, b = 0;
        if (hex.length == 4) {
            r = "0x" + hex[1] + hex[1];
            g = "0x" + hex[2] + hex[2];
            b = "0x" + hex[3] + hex[3];
        } else if (hex.length == 7) {
            r = "0x" + hex.substring(1, 3);
            g = "0x" + hex.substring(3, 5);
            b = "0x" + hex.substring(5, 7);
        }
        return `rgba(${+r},${+g},${+b},${alpha})`;
    }

    // 円グラフ
    if (chartDataJSON) {
        try {
            const chartData = JSON.parse(chartDataJSON);
            const filteredLabels = [], filteredValues = [], filteredColors = [];
            chartData.values.forEach((value, index) => {
                if (value > 0) {
                    filteredLabels.push(chartData.labels[index]);
                    filteredValues.push(value);
                    filteredColors.push(assetColors[index]);
                }
            });

            if (filteredValues.length > 0) {
                const ctxPie = document.getElementById('assetPieChart').getContext('2d');
                new Chart(ctxPie, {
                    type: 'pie',
                    data: {
                        labels: filteredLabels,
                        datasets: [{ 
                            data: filteredValues, 
                            backgroundColor: filteredColors, 
                            borderColor: '#fff', 
                            borderWidth: 2 
                        }]
                    },
                    options: {
                        responsive: true, 
                        maintainAspectRatio: false,
                        devicePixelRatio: 3, // ✅ 高画質化
                        plugins: {
                            legend: { display: false },
                            title: { display: false },
                            datalabels: {
                                formatter: (value, context) => {
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = (value / total) * 100;
                                    if (percentage < 3) return '';
                                    const label = context.chart.data.labels[context.dataIndex];
                                    return `${percentage.toFixed(1)}%\n${label}`;
                                },
                                color: '#fff', 
                                textAlign: 'center', 
                                font: { weight: 'bold', size: 13 },
                                textShadowBlur: 6, 
                                textShadowColor: 'rgba(0, 0, 0, 0.6)',
                                offset: 0
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => ` ${context.label}: ${new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(context.parsed)}`
                                }
                            }
                        }
                    }
                });
            }
        } catch (e) { console.error("Pie chart error:", e); }
    }

    if (historyDataJSON) {
        try {
            const historyData = JSON.parse(historyDataJSON);
            if (historyData.dates && historyData.dates.length > 0) {
                const ctxLine = document.getElementById('assetLineChart').getContext('2d');
                const lineDatasetConfigs = [
                    { label: '総資産', data: historyData.total, color: totalAssetColor, hidden: false },
                    { label: '日本株', data: historyData.jp_stock, color: assetColors[0], hidden: true },
                    { label: '米国株', data: historyData.us_stock, color: assetColors[1], hidden: true },
                    { label: '現金', data: historyData.cash, color: assetColors[2], hidden: true },
                    { label: '貴金属', data: historyData.gold, color: assetColors[3], hidden: true },
                    { label: '暗号資産', data: historyData.crypto, color: assetColors[4], hidden: true },
                    { label: '投資信託', data: historyData.investment_trust, color: assetColors[5], hidden: true },
                    { label: '保険', data: historyData.insurance, color: assetColors[6], hidden: true }
                ];
                const lineDatasets = lineDatasetConfigs.map(config => ({
                    label: config.label, data: config.data, borderColor: config.color,
                    backgroundColor: hexToRgba(config.color, 0.2), fill: true, tension: 0.4,
                    borderWidth: 2, pointRadius: 1, pointHoverRadius: 5, hidden: config.hidden
                }));
                myLineChart = new Chart(ctxLine, {
                    type: 'line',
                    data: { labels: historyData.dates, datasets: lineDatasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        devicePixelRatio: 3, // ✅ 高画質化
                        plugins: { 
                            legend: { display: false }, 
                            title: { display: false },
                            datalabels: { display: false },
                            tooltip: {
                                mode: 'index', intersect: false,
                                callbacks: {
                                    label: (context) => ` ${context.dataset.label}: ${new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(context.parsed.y)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: (value) => {
                                        if (value >= 1e8) return `¥${(value/1e8).toFixed(1)}億`;
                                        if (value >= 1e4) return `¥${(value/1e4).toFixed(0)}万`;
                                        return `¥${value.toLocaleString()}`;
                                    }
                                }
                            }
                        }
                    }
                });

                const lineToggles = document.querySelectorAll('.line-toggle');
                const updateLineVisuals = () => {
                    lineToggles.forEach(toggle => {
                        const colorBox = toggle.nextElementSibling;
                        if (colorBox) colorBox.style.opacity = toggle.checked ? '1.0' : '0.4';
                    });
                };
                document.getElementById('toggle-all-lines').addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    lineToggles.forEach(toggle => {
                        toggle.checked = isChecked;
                        const index = toggle.getAttribute('data-dataset-index');
                        myLineChart.getDatasetMeta(parseInt(index)).hidden = !isChecked;
                    });
                    myLineChart.update();
                    updateLineVisuals();
                });
                lineToggles.forEach(toggle => {
                    toggle.addEventListener('change', () => {
                        const index = toggle.getAttribute('data-dataset-index');
                        myLineChart.getDatasetMeta(parseInt(index)).hidden = !toggle.checked;
                        myLineChart.update();
                        updateLineVisuals();
                    });
                });
                updateLineVisuals();
            }
        } catch (e) { console.error("History chart error:", e); }
    }
    
    // 初期タブ表示の処理
    const portfolioButton = document.querySelector('.tab-nav .tab-btn.active');
    if (portfolioButton) {
        showTab('portfolio', portfolioButton);
    }
});
</script>